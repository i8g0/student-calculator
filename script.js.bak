// ===== GLOBAL VARIABLES =====
let currentTheme = localStorage.getItem('theme') || 'light';
let calculations = JSON.parse(localStorage.getItem('calculations')) || [];
let currentTab = 'rate';
let summaryBarChart = null;
let rateGradePie = null;
let rateBarChart = null;

// ===== DOM ELEMENTS =====
const loadingScreen = document.getElementById('loading-screen');
const themeToggle = document.getElementById('theme-toggle');
const menuToggle = document.getElementById('menu-toggle');
const mobileMenu = document.getElementById('mobile-menu');
const closeMenu = document.getElementById('close-menu');
const tabBtns = document.querySelectorAll('.tab-btn');
const tabContents = document.querySelectorAll('.tab-content');
const toastContainer = document.getElementById('toast-container');
const themeSwitcher = document.getElementById('theme-switcher');
const themes = ['theme-dark', 'theme-light', 'theme-colorful'];
let currentThemeIdx = 0;

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
    // Ø²Ø± Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù† ÙŠÙ†Ø²Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ù‚Ø³Ù… Ø§Ù„Ø±ÙŠØª Ù…Ø¹ ØªØ¹ÙˆÙŠØ¶ Ø§Ù„ØªØ±ÙˆÙŠØ³Ø©
    const ctaBtn = document.querySelector('.cta-btn');
    if (ctaBtn) {
        ctaBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const target = document.getElementById('rate');
            if (target) {
                const navbar = document.querySelector('.navbar');
                const navHeight = navbar ? navbar.offsetHeight : 0;
                const extraOffset = 150; // Ù…Ø³Ø§ÙØ© Ø¥Ø¶Ø§ÙÙŠØ© Ù„ÙŠØ¸Ù‡Ø± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙÙŠ Ù…Ù†ØªØµÙ Ø§Ù„Ø´Ø§Ø´Ø©
                const targetPos = target.getBoundingClientRect().top + window.pageYOffset - navHeight - extraOffset;
                window.scrollTo({ top: targetPos, behavior: 'smooth' });
            }
        });
    }
});

function initializeApp() {
    // Show loading screen
    setTimeout(() => {
        loadingScreen.classList.add('hidden');
        setTimeout(() => {
            loadingScreen.style.display = 'none';
        }, 500);
    }, 2000);

    // Initialize theme
    setTheme(currentTheme);
    
    // Initialize particles
    initParticles();
    
    // Initialize charts
    initCharts();
    
    // Initialize event listeners
    initEventListeners();
    
    // Initialize forms
    initForms();
    
    // Initialize course search (after a delay to ensure DOM is ready)
    setTimeout(() => {
        createCourseSearchField();
        setupCourseSearchEvents();
    }, 1000);
    
    // Update analytics
    updateAnalytics();
    
    // Show welcome toast
    showToast('Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø±ÙŠØª Ø§Ù„Ø°ÙƒÙŠØ©! ðŸš€', 'info');
}

// ===== THEME MANAGEMENT =====
function setTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    currentTheme = theme;
    localStorage.setItem('theme', theme);
    
    // Update theme toggle icon
        const icon = themeToggle.querySelector('i');
    icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
}

function toggleTheme() {
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
    setTheme(newTheme);
    showToast(`ØªÙ… ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¸Ù‡Ø± Ø¥Ù„Ù‰ ${newTheme === 'dark' ? 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¸Ù„Ù…' : 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­'}`, 'success');
}

function applyTheme(idx) {
    document.body.classList.remove(...themes);
    document.body.classList.add(themes[idx]);
    localStorage.setItem('theme', themes[idx]);
}

if (themeSwitcher) {
    themeSwitcher.addEventListener('click', function() {
        currentThemeIdx = (currentThemeIdx + 1) % themes.length;
        applyTheme(currentThemeIdx);
    });
}

// Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©ØŒ Ø·Ø¨Ù‘Ù‚ Ø¢Ø®Ø± Ø«ÙŠÙ… Ù…Ø­ÙÙˆØ¸
const savedTheme = localStorage.getItem('theme');
if (savedTheme && themes.includes(savedTheme)) {
    document.body.classList.add(savedTheme);
    currentThemeIdx = themes.indexOf(savedTheme);
} else {
    document.body.classList.add('theme-dark');
    currentThemeIdx = 0;
}

// ===== PARTICLES BACKGROUND =====
function initParticles() {
    if (typeof particlesJS !== 'undefined') {
        particlesJS('particles-js', {
            particles: {
                number: {
                    value: 80,
                    density: {
                        enable: true,
                        value_area: 800
                    }
                },
                color: {
                    value: '#ffffff'
                },
                shape: {
                    type: 'circle',
                    stroke: {
                        width: 0,
                        color: '#000000'
                    }
                },
                opacity: {
                    value: 0.5,
                    random: false,
                    anim: {
                        enable: false,
                        speed: 1,
                        opacity_min: 0.1,
                        sync: false
                    }
                },
                size: {
                    value: 3,
                    random: true,
                    anim: {
                        enable: false,
                        speed: 40,
                        size_min: 0.1,
                        sync: false
                    }
                },
                line_linked: {
                    enable: true,
                    distance: 150,
                    color: '#ffffff',
                    opacity: 0.4,
                    width: 1
                },
                move: {
                    enable: true,
                    speed: 6,
                    direction: 'none',
                    random: false,
                    straight: false,
                    out_mode: 'out',
                    bounce: false,
                    attract: {
                        enable: false,
                        rotateX: 600,
                        rotateY: 1200
                    }
                }
            },
            interactivity: {
                detect_on: 'canvas',
                events: {
                    onhover: {
                        enable: true,
                        mode: 'repulse'
                    },
                    onclick: {
                        enable: true,
                        mode: 'push'
                    },
                    resize: true
                },
                modes: {
                    grab: {
                        distance: 400,
                        line_linked: {
                            opacity: 1
                        }
                    },
                    bubble: {
                        distance: 400,
                        size: 40,
                        duration: 2,
                        opacity: 8,
                        speed: 3
                    },
                    repulse: {
                        distance: 200,
                        duration: 0.4
                    },
                    push: {
                        particles_nb: 4
                    },
                    remove: {
                        particles_nb: 2
                    }
                }
            },
            retina_detect: true
        });
    }
}

// ===== TAB SYSTEM =====
function initTabs() {
    tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const tabId = btn.dataset.tab;
            switchTab(tabId);
        });
    });
}

function switchTab(tabId) {
    // Remove active class from all tabs and contents
    tabBtns.forEach(btn => btn.classList.remove('active'));
    tabContents.forEach(content => content.classList.remove('active'));
    
    // Add active class to selected tab and content
    document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
    document.getElementById(tabId).classList.add('active');
    
    currentTab = tabId;
    
    // Update mobile menu if open
    if (mobileMenu.classList.contains('active')) {
        mobileMenu.classList.remove('active');
    }
}

// ===== MOBILE MENU =====
function initMobileMenu() {
    menuToggle.addEventListener('click', () => {
        mobileMenu.classList.add('active');
    });
    
    closeMenu.addEventListener('click', () => {
        mobileMenu.classList.remove('active');
    });
    
    // Close menu when clicking outside
    document.addEventListener('click', (e) => {
        if (!mobileMenu.contains(e.target) && !menuToggle.contains(e.target)) {
            mobileMenu.classList.remove('active');
        }
    });
    
    // Menu item clicks
    document.querySelectorAll('.menu-item').forEach(item => {
        item.addEventListener('click', (e) => {
            e.preventDefault();
            const href = item.getAttribute('href');
            const tabId = href.substring(1);
            switchTab(tabId);
        });
    });
}

// ===== FORM INITIALIZATION =====
function initForms() {
    // Rate calculator form
    const rateForm = document.getElementById('rate-form');
    const rateNumInput = document.getElementById('rate-num');
    const rateCoursesContainer = document.getElementById('rate-courses');
    
    if (rateNumInput) {
        rateNumInput.addEventListener('change', () => {
            createCourseInputs(rateCoursesContainer, parseInt(rateNumInput.value), 'rate');
        });
    }
    
    if (rateForm) {
        rateForm.addEventListener('submit', handleRateCalculation);
    }
    
    // Science College calculator form
    const scienceCollegeForm = document.getElementById('science-college-form');
    if (scienceCollegeForm) {
        scienceCollegeForm.addEventListener('submit', handleScienceCollegeCalculation);
    }
    
    // Applied College calculator form
    const appliedCollegeForm = document.getElementById('applied-college-form');
    if (appliedCollegeForm) {
        appliedCollegeForm.addEventListener('submit', handleAppliedCollegeCalculation);
    }
    
    // Cumulative GPA form
    const cumulativeForm = document.getElementById('cumulative-form');
    const cumulativeNumInput = document.getElementById('cumulative-num');
    const cumulativeCoursesContainer = document.getElementById('cumulative-courses');
    
    if (cumulativeNumInput) {
        cumulativeNumInput.addEventListener('change', () => {
            createCourseInputs(cumulativeCoursesContainer, parseInt(cumulativeNumInput.value), 'cumulative');
        });
    }
    
    if (cumulativeForm) {
        cumulativeForm.addEventListener('submit', handleCumulativeCalculation);
    }
    
    // Semester GPA form
    const semesterForm = document.getElementById('semester-form');
    const semesterNumInput = document.getElementById('semester-num');
    const semesterCoursesContainer = document.getElementById('semester-courses');
    
    if (semesterNumInput) {
        semesterNumInput.addEventListener('change', () => {
            createCourseInputs(semesterCoursesContainer, parseInt(semesterNumInput.value), 'semester');
        });
    }
    
    if (semesterForm) {
        semesterForm.addEventListener('submit', handleSemesterCalculation);
    }
    
    // Initialize course inputs
    if (rateNumInput) createCourseInputs(rateCoursesContainer, parseInt(rateNumInput.value) || 2, 'rate');
    if (cumulativeNumInput) createCourseInputs(cumulativeCoursesContainer, parseInt(cumulativeNumInput.value) || 2, 'cumulative');
    if (semesterNumInput) createCourseInputs(semesterCoursesContainer, parseInt(semesterNumInput.value) || 2, 'semester');
}

// ===== COURSE INPUTS CREATION =====
function createCourseInputs(container, numCourses, type) {
    container.innerHTML = '';
    for (let i = 1; i <= numCourses; i++) {
        const courseItem = document.createElement('div');
        courseItem.className = 'course-item';
        courseItem.innerHTML = `
            <div class="course-header">
                <span class="course-name">Ø§Ù„Ù…Ø§Ø¯Ø© ${i}</span>
            </div>
            <div class="course-inputs">
                <div class="form-group">
                    <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø§Øª</label>
                    <input type="number" id="${type}-course-${i}-hours" min="1" max="10" step="1" required>
                </div>
                <div class="form-group">
                    <label>Ø§Ø®ØªØ± Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</label>
                    <select id="${type}-course-${i}-grade" required>
                        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ØªÙ‚Ø¯ÙŠØ± --</option>
                        <option value="A+">A+</option>
                        <option value="A">A</option>
                        <option value="B+">B+</option>
                        <option value="B">B</option>
                        <option value="C+">C+</option>
                        <option value="C">C</option>
                        <option value="D+">D+</option>
                        <option value="D">D</option>
                        <option value="F">F</option>
                    </select>
                </div>
            </div>
        `;
        container.appendChild(courseItem);
    }
}

// ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ÙˆØ§Ø¯ ÙˆØ§Ù„Ø£ÙˆØ²Ø§Ù† Ø­Ø³Ø¨ Ø§Ù„ØªØ®ØµØµ (Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯)
const majorCourses = {
    CE: [ // Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ø­Ø§Ø³Ø¨
        { name: "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø§Ù„Ù…ØªÙ‚Ø·Ø¹Ø© (1112Ø¹Ø§Ù„)", weight: 0.5 },
        { name: "Ø¨Ø±Ù…Ø¬Ø© Ø§Ù„Ø­Ø§Ø³Ø¨ 1 (1301Ø¹Ø§Ù„)", weight: 0.5 }
    ],
    CS: [ // Ø¹Ù„ÙˆÙ… Ø§Ù„Ø­Ø§Ø³Ø¨
        { name: "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø§Ù„Ù…ØªÙ‚Ø·Ø¹Ø© (1112Ø¹Ø§Ù„)", weight: 0.25 },
        { name: "Ø¨Ø±Ù…Ø¬Ø© Ø§Ù„Ø­Ø§Ø³Ø¨ 1 (1301Ø¹Ø§Ù„)", weight: 0.75 }
    ],
    IS: [ // Ù†Ø¸Ù… Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
        { name: "Ø¨Ø±Ù…Ø¬Ø© Ø§Ù„Ø­Ø§Ø³Ø¨ 1 (1301Ø¹Ø§Ù„)", weight: 0.5 },
        { name: "Ø£Ø³Ø§Ø³ÙŠØ§Øª Ù†Ø¸Ù… Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (2511Ù†Ø§Ù„)", weight: 0.5 }
    ],
    SE: [ // Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠØ§Øª
        { name: "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø§Ù„Ù…ØªÙ‚Ø·Ø¹Ø© (1112Ø¹Ø§Ù„)", weight: 0.5 },
        { name: "Ø¨Ø±Ù…Ø¬Ø© Ø§Ù„Ø­Ø§Ø³Ø¨ 1 (1301Ø¹Ø§Ù„)", weight: 0.5 }
    ]
};

const gradeValues = {
    "A+": 5,
    "A": 4.75,
    "B+": 4.5,
    "B": 4,
    "C+": 3.5,
    "C": 3,
    "D+": 2.5,
    "D": 2,
    "F": 1
};

// Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ØªØ®ØµØµØŒ Ø£Ø¸Ù‡Ø± Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
const majorSelect = document.getElementById('major');
const rateCoursesDiv = document.getElementById('rate-courses');
if (majorSelect && rateCoursesDiv) {
    majorSelect.addEventListener('change', function() {
        const major = majorSelect.value;
        rateCoursesDiv.innerHTML = '';
        if (major && majorCourses[major]) {
            majorCourses[major].forEach((course, idx) => {
                const courseDiv = document.createElement('div');
                courseDiv.className = 'form-group';
                courseDiv.innerHTML = `
                    <label for="rate-course-${idx}">${course.name}</label>
                    <select id="rate-course-${idx}" required>
                            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ØªÙ‚Ø¯ÙŠØ± --</option>
                        <option value="A+">A+</option>
                        <option value="A">A</option>
                        <option value="B+">B+</option>
                        <option value="B">B</option>
                        <option value="C+">C+</option>
                        <option value="C">C</option>
                        <option value="D+">D+</option>
                        <option value="D">D</option>
                        <option value="F">F</option>
                        </select>
                `;
                rateCoursesDiv.appendChild(courseDiv);
            });
        }
    });
}

// Ø¹Ø¯Ù„ Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±ÙŠØª Ù„ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
function handleRateCalculation(e) {
    e.preventDefault();
    const major = document.getElementById('major').value;
    const gpa = parseFloat(document.getElementById('rate-gpa').value);
    const sa = parseFloat(document.getElementById('rate-sa').value);
    if (!major || isNaN(gpa) || isNaN(sa)) {
        showToast('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'error');
        return;
    }
    // Ø¬Ù„Ø¨ ØªÙ‚Ø¯ÙŠØ±Ø§Øª Ø§Ù„Ù…ÙˆØ§Ø¯
    const courses = majorCourses[major];
    const g1 = gradeValues[document.getElementById('rate-course-0').value];
    const w1 = courses[0].weight;
    const g2 = gradeValues[document.getElementById('rate-course-1').value];
    const w2 = courses[1].weight;
    if (g1 === undefined || g2 === undefined) {
        showToast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØªÙ‚Ø¯ÙŠØ± Ù„ÙƒÙ„ Ù…Ø§Ø¯Ø©', 'error');
        return;
    }
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±ÙŠØª
    const result = calculateRate(major, gpa, sa, g1, w1, g2, w2);
    displayRateResult(result);
    saveCalculation({
        type: 'rate',
        major,
        gpa,
        sa,
        g1,
        w1,
        g2,
        w2,
        result,
        timestamp: new Date().toISOString()
    });
    showToast('ØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±ÙŠØª Ø¨Ù†Ø¬Ø§Ø­! ðŸŽ‰', 'success');
    updateAnalytics();
}

function handleCumulativeCalculation(e) {
    e.preventDefault();
    const prevHours = parseFloat(document.getElementById('prev-hours').value);
    const prevGpa = parseFloat(document.getElementById('prev-gpa').value);
    if (isNaN(prevHours) || isNaN(prevGpa)) {
        showToast('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'error');
        return;
    }
    const courseInputs = document.querySelectorAll('#cumulative-courses .course-item');
    const courses = [];
    courseInputs.forEach((course, index) => {
        const hours = parseFloat(course.querySelector(`#cumulative-course-${index + 1}-hours`).value);
        const grade = gradeValues[course.querySelector(`#cumulative-course-${index + 1}-grade`).value];
        if (!isNaN(hours) && grade !== undefined) {
            courses.push({ hours, grade });
        }
    });
    if (courses.length === 0) {
        showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ§Ø¯', 'error');
        return;
    }
    const result = calculateCumulativeGPA(prevHours, prevGpa, courses);
    displayCumulativeResult(result);
    saveCalculation({
        type: 'cumulative',
        prevHours,
        prevGpa,
        courses,
        result,
        timestamp: new Date().toISOString()
    });
    showToast('ØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ Ø¨Ù†Ø¬Ø§Ø­! ðŸ“Š', 'success');
    updateAnalytics();
}

function handleSemesterCalculation(e) {
    e.preventDefault();
    const courseInputs = document.querySelectorAll('#semester-courses .course-item');
    const courses = [];
    courseInputs.forEach((course, index) => {
        const hours = parseFloat(course.querySelector(`#semester-course-${index + 1}-hours`).value);
        const grade = gradeValues[course.querySelector(`#semester-course-${index + 1}-grade`).value];
        if (!isNaN(hours) && grade !== undefined) {
            courses.push({ hours, grade });
        }
    });
    if (courses.length === 0) {
        showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ§Ø¯', 'error');
        return;
    }
    const result = calculateSemesterGPA(courses);
    displaySemesterResult(result);
    saveCalculation({
        type: 'semester',
        courses,
        result,
        timestamp: new Date().toISOString()
    });
    showToast('ØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙØµÙ„ÙŠ Ø¨Ù†Ø¬Ø§Ø­! ðŸŽ“', 'success');
    updateAnalytics();
}

function handleScienceCollegeCalculation(e) {
    e.preventDefault();
    const gpa = parseFloat(document.getElementById('sc-gpa').value);
    const weighted = parseFloat(document.getElementById('sc-weighted').value);
    const physics = gradeValues[document.getElementById('sc-physics').value];
    const differential = gradeValues[document.getElementById('sc-differential').value];
    const integral = gradeValues[document.getElementById('sc-integral').value];
    if (isNaN(gpa) || isNaN(weighted) || physics === undefined || differential === undefined || integral === undefined) {
        showToast('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'error');
        return;
    }
    // Ø­Ø³Ø§Ø¨ Ù…Ø¹Ø¯Ù„ ÙƒÙ„ÙŠØ© Ø§Ù„Ø¹Ù„ÙˆÙ…
    const result = calculateScienceCollegeRate(gpa, weighted, physics, differential, integral);
    displayScienceCollegeResult(result);
    saveCalculation({
        type: 'science-college',
        gpa,
        weighted,
        physics,
        differential,
        integral,
        result,
        timestamp: new Date().toISOString()
    });
    showToast('ØªÙ… Ø­Ø³Ø§Ø¨ Ù…Ø¹Ø¯Ù„ ØªØ®ØµÙŠØµ ÙƒÙ„ÙŠØ© Ø§Ù„Ø¹Ù„ÙˆÙ… Ø¨Ù†Ø¬Ø§Ø­! ðŸ§ª', 'success');
    updateAnalytics();
}

function handleAppliedCollegeCalculation(e) {
    e.preventDefault();
    const gpa = parseFloat(document.getElementById('ac-gpa').value);
    const composite = parseFloat(document.getElementById('ac-composite').value);
    const organicChemistry = gradeValues[document.getElementById('ac-organic-chemistry').value];
    const biology = gradeValues[document.getElementById('ac-biology').value];
    if (isNaN(gpa) || isNaN(composite) || organicChemistry === undefined || biology === undefined) {
        showToast('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'error');
        return;
    }
    // Ø­Ø³Ø§Ø¨ Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙƒÙ„ÙŠØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ÙŠØ©
    const result = calculateAppliedCollegeRate(gpa, composite, organicChemistry, biology);
    displayAppliedCollegeResult(result);
    saveCalculation({
        type: 'applied-college',
        gpa,
        composite,
        organicChemistry,
        biology,
        result,
        timestamp: new Date().toISOString()
    });
    showToast('ØªÙ… Ø­Ø³Ø§Ø¨ Ù…Ø¹Ø¯Ù„ ØªØ®ØµÙŠØµ Ø§Ù„ÙƒÙ„ÙŠØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­! ðŸ”¬', 'success');
    updateAnalytics();
}

// ===== CALCULATION FUNCTIONS =====
function calculateRate(major, gpa, sa, g1, w1, g2, w2) {
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±ÙŠØª Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    // RATE = (GPA + SA + (W1*G1) + (W2*G2)) / 3
    const rate = (gpa + sa + (w1 * g1) + (w2 * g2)) / 3;
    return {
        rate: rate.toFixed(3),
        gpa,
        sa,
        g1,
        w1,
        g2,
        w2,
        breakdown: {
            gpa: gpa.toFixed(3),
            sa: sa.toFixed(3),
            g1: g1.toFixed(3),
            w1: w1.toFixed(2),
            g2: g2.toFixed(3),
            w2: w2.toFixed(2),
            g1w1: (g1*w1).toFixed(3),
            g2w2: (g2*w2).toFixed(3)
        }
    };
}

function calculateCumulativeGPA(prevHours, prevGpa, courses) {
    const prevPoints = prevHours * prevGpa;
    const newHours = courses.reduce((sum, course) => sum + course.hours, 0);
    const newPoints = courses.reduce((sum, course) => sum + (course.grade * course.hours), 0);
    
    const totalHours = prevHours + newHours;
    const totalPoints = prevPoints + newPoints;
    const cumulativeGpa = totalPoints / totalHours;
    
    return {
        cumulativeGpa: cumulativeGpa.toFixed(3),
        prevGpa,
        newGpa: (newPoints / newHours).toFixed(3),
        totalHours,
        newHours,
        courses
    };
}

function calculateSemesterGPA(courses) {
    const totalHours = courses.reduce((sum, course) => sum + course.hours, 0);
    const totalPoints = courses.reduce((sum, course) => sum + (course.grade * course.hours), 0);
    const semesterGpa = totalPoints / totalHours;
    
    return {
        semesterGpa: semesterGpa.toFixed(3),
        totalHours,
        courses,
        gradeDistribution: getGradeDistribution(courses)
    };
}

function calculateScienceCollegeRate(gpa, weighted, physics, differential, integral) {
    const weighted5 = weighted / 20;
    const finalRate = (gpa * 0.5) + (weighted5 * 0.3) + (physics * 0.1) + (differential * 0.05) + (integral * 0.05);
    return {
        finalRate: finalRate.toFixed(2),
        gpa: gpa,
        weighted: weighted,
        physics: physics,
        differential: differential,
        integral: integral,
        breakdown: {
            gpaContribution: (gpa * 0.5).toFixed(3),
            weightedContribution: (weighted5 * 0.3).toFixed(3),
            physicsContribution: (physics * 0.1).toFixed(3),
            differentialContribution: (differential * 0.05).toFixed(3),
            integralContribution: (integral * 0.05).toFixed(3)
        }
    };
}

function calculateAppliedCollegeRate(gpa, composite, organicChemistry, biology) {
    const composite5 = composite / 20;
    const finalRate = (gpa * 0.5) + (composite5 * 0.3) + (organicChemistry * 0.1) + (biology * 0.1);
    return {
        finalRate: finalRate.toFixed(2),
        gpa: gpa,
        composite: composite,
        organicChemistry: organicChemistry,
        biology: biology,
        breakdown: {
            gpaContribution: (gpa * 0.5).toFixed(3),
            compositeContribution: (composite5 * 0.3).toFixed(3),
            organicChemistryContribution: (organicChemistry * 0.1).toFixed(3),
            biologyContribution: (biology * 0.1).toFixed(3)
        }
    };
}

function getGradeDistribution(courses) {
    const distribution = {
        'A+': 0, 'A': 0, 'B+': 0, 'B': 0, 'C+': 0, 'C': 0, 'D+': 0, 'D': 0, 'F': 0
    };
    
    courses.forEach(course => {
        const grade = getLetterGrade(course.grade);
        distribution[grade]++;
    });
    
    return distribution;
}

function getLetterGrade(numericGrade) {
    if (numericGrade >= 4.5) return 'A+';
    if (numericGrade >= 4.0) return 'A';
    if (numericGrade >= 3.5) return 'B+';
    if (numericGrade >= 3.0) return 'B';
    if (numericGrade >= 2.5) return 'C+';
    if (numericGrade >= 2.0) return 'C';
    if (numericGrade >= 1.5) return 'D+';
    if (numericGrade >= 1.0) return 'D';
    return 'F';
}

// ===== RESULT DISPLAY =====n